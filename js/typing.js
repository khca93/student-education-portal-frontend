// typing.js - D:\WEBFILE\StudentEducationPortal\frontend\js\typing.js

// ================= LESSON DATA =================


const lessons = {
    1: {
        title: "Home Row Fundamentals",
        description: "Master the home row keys (QWERTY POIUY) with proper finger positioning. Build muscle memory with 500+ characters of targeted practice.",
        text: `qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy qwert poiuy`,
        targetChars: 507,
        type: "normal"
    },
    2: {
        title: "Second Row - ASDFG ;LKJH",
        description: "Master the second row keys with proper finger movements. Practice with 500-510 characters.",
        text: `asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh asdfg ;lkjh`,
        targetChars: 503,
        type: "normal"
    },
    3: {
        title: "Third Row - ZXCVB/.,MN",
        description: "Learn the third row keys with proper technique. Practice with 500-510 characters.",
        text: `zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn zxcvb /.,mn`,
        targetChars: 505,
        type: "normal"
    },
    4: {
        title: "A to Z (Forward)",
        description: "Practice typing alphabet A to Z repeatedly. 26 letters Ã— 50 times.",
        text: generateAlphabetText(true),
        targetChars: 1300,
        type: "normal"
    },
    5: {
        title: "Z to A (Reverse)",
        description: "Practice typing alphabet Z to A repeatedly. 26 letters Ã— 50 times.",
        text: generateAlphabetText(false),
        targetChars: 1300,
        type: "normal"
    },
    6: {
        title: "Basic Words Practice",
        description: "Practice typing 100 common English words to build vocabulary and typing skill.",
        text: `the and you that was for are with his they this have from one had by word but not what all were when your can said there use an each which she do how their if will up other about out many then them these so some her would make like him into time has look two more write go see number no way could people my than first water been call who oil its now find long down day did get come made may part over new sound take only little work know place year live me back give most very after thing our just name good sentence man think say great where help through much before line right too mean old any same tell boy follow came want show also around form three small set put end does another well large must big even such because turn here why ask went men read need land different home us move try kind hand picture again change off play spell air away animal house point page letter mother answer found study still learn should America world`,
        targetChars: 600,
        type: "normal"
    },
    7: {
        title: "Short Sentences",
        description: "Practice typing 20 short sentences. Press Enter after each sentence.",
        text: `The sun is shining brightly today.\nI enjoy reading books in my free time.\nCooking is both an art and a science.\nDogs are known to be loyal companions.\nTechnology continues to evolve rapidly.\nMusic has the power to heal the soul.\nExercise is essential for good health.\nLearning a new language is challenging.\nNature provides us with beautiful scenery.\nTraveling broadens our perspectives.\nKindness is a universal language.\nTime management is a valuable skill.\nReading improves vocabulary and knowledge.\nWater is essential for all living things.\nFriendship is built on trust and respect.\nEducation opens doors to opportunities.\nHard work often leads to success.\nLaughter is the best medicine.\nPatience is a key virtue in life.\nDreams give us hope for the future.`,
        targetChars: 800,
        type: "normal"
    },
    8: {
        title: "Paragraph Practice",
        description: "Practice typing paragraphs. Select one from dropdown.",
        text: "",
        paragraphs: [
            "Typing is an essential skill in today's digital world. Whether you are a student, professional, or simply using a computer for personal tasks, good typing skills can save you time and increase productivity. The ability to type quickly and accurately allows you to communicate more effectively through emails, documents, and online platforms. Many jobs now require basic typing skills, and some positions specifically test typing speed during the hiring process. Regular practice is key to improving your typing abilities. Start with simple exercises and gradually increase the complexity of the text you practice with.",
            "Pay attention to proper finger placement on the keyboard, as this foundation will help you type more efficiently in the long run. Using all ten fingers rather than just a few will significantly increase your speed over time. Remember that accuracy is just as important as speed when it comes to typing. It's better to type slightly slower with fewer errors than to type quickly but make many mistakes that need correction. Most typing software and online platforms provide immediate feedback on your performance, allowing you to identify areas that need improvement.",
            "Set aside a few minutes each day for focused typing practice, and you will see noticeable progress within a few weeks. Consistency in practice matters more than the length of each practice session. Even 15-20 minutes of daily practice can lead to significant improvement over time. Track your progress by noting your words per minute and accuracy percentage after each session. This will help you stay motivated as you see your numbers improve. Don't get discouraged by initial slow speeds; everyone starts somewhere, and with regular practice, your typing will become more automatic and fluid.",
            "Consider learning touch typing, where you type without looking at the keyboard. This method may be challenging at first but offers the greatest long-term benefits for speed and accuracy. Many free online resources and typing tutors are available to help you learn proper techniques. Some programs even turn typing practice into games, making the learning process more enjoyable. As you become more comfortable with typing, challenge yourself with different types of text, including numbers, symbols, and specialized vocabulary related to your field of study or work.",
            "Good typing skills not only make you more efficient but also reduce physical strain, as proper technique minimizes the risk of repetitive strain injuries. Pay attention to your posture while typing, keeping your back straight, feet flat on the floor, and wrists in a neutral position. Take regular breaks during extended typing sessions to rest your eyes and hands. In our increasingly digital world, typing has become as fundamental as writing was in previous generations. Whether you're preparing for exams, applying for jobs, or simply communicating with others, strong typing skills give you a significant advantage.",
        ],
        targetChars: 400,
        type: "paragraph"
    },
    9: {
        title: "TypeFall Game",
        description: "Fast-paced typing game - Type falling words before they reach the bottom!",
        text: "",
        targetChars: 0,
        type: "typefall"
    },
    10: {
        title: "Advanced Practice",
        description: "Practice advanced paragraphs. Select one from dropdown.",
        text: "",
        paragraphs: [
            "The Indian education system has played a major role in shaping the nation by producing skilled professionals across various fields, yet it still faces several challenges that limit the overall growth of students, especially in todayâ€™s rapidly changing world. The system is largely focused on examinations, marks, and theoretical knowledge, which often encourages memorisation rather than understanding, practical application, or skill development. As a result, many students complete their education with degrees but lack the confidence, technical skills, and real-world exposure required for employment. This gap between education and employability is one of the biggest concerns in India, particularly for students from rural and semi-urban areas who have limited access to quality resources, career guidance, and modern technology. In such a scenario, platforms like Knowledge Hunt play a crucial role in supporting and strengthening the education ecosystem by providing skill-based, practical, and career-oriented learning. Knowledge Hunt focuses on empowering students with essential skills such as computer literacy, office automation, financial accounting, typing proficiency, digital tools, and exam-oriented practice, which are directly useful in professional and everyday work environments. Unlike traditional education methods, Knowledge Hunt emphasises hands-on training and step-by-step learning, helping students understand not only what to learn but also how to apply that knowledge in real-life situations. It also provides career guidance, job alerts, practice materials, and structured learning paths that help students make informed decisions about their future. One of the strongest aspects of Knowledge Hunt is its commitment to accessibility and inclusivity, as it supports learners from small towns and rural backgrounds who may not have access to expensive coaching centres or advanced educational facilities. By using simple explanations, practical examples, and technology-enabled learning, Knowledge Hunt makes education more approachable and reduces fear around computers and technical subjects. In a country like India, where the youth population is large and diverse, skill development and continuous learning are essential for national growth. Knowledge Hunt helps bridge the gap between formal education and employment by complementing academic knowledge with practical skills, confidence-building, and career readiness. Through its focused approach on learning with purpose, Knowledge Hunt contributes to building a more skilled, self-reliant, and future-ready generation, ensuring that students are prepared not just to pass exams, but to succeed in real life.",
            "Computer typing has become one of the most essential skills in todayâ€™s Indian job market, as almost every sector now depends on digital work, documentation, online communication, and data handling, making typing speed and accuracy a basic requirement rather than an additional qualification. From government offices, banks, courts, schools, hospitals, and private companies to small businesses and startups, typing is used daily for preparing letters, reports, emails, bills, data entry, online forms, and official records. In many government and semi-government jobs such as clerk, data entry operator, stenographer, junior assistant, court typist, and office assistant, computer typing tests are a compulsory part of the recruitment process, and candidates are often disqualified not because they lack knowledge, but because they fail to meet the required typing speed or accuracy. Similarly, in the private sector, employers expect candidates to work efficiently on computers with proper typing skills, as slow typing reduces productivity and increases workload. Despite this growing demand, many students in India complete their education without proper typing practice, as the traditional education system focuses more on theory and exams rather than practical digital skills. Students from rural and semi-urban areas face even greater difficulty due to limited access to computers, structured typing training, and professional guidance, which creates a skill gap and reduces their employment opportunities. In this situation, platforms like Knowledge Hunt play a vital role in preparing students for the modern job market by providing systematic and practical computer typing training along with overall digital skill development. Knowledge Hunt helps learners improve their typing speed, accuracy, and confidence through regular practice, guided exercises, and performance tracking, enabling them to meet the standards required for government and private job exams. It also familiarises students with real office-work scenarios, helping them understand how typing skills are applied in daily professional tasks. By offering step-by-step learning, easy instructions, and a supportive environment, Knowledge Hunt makes typing practice accessible even for beginners and students with limited technical background. In addition to typing skills, Knowledge Hunt supports students with exam preparation, job alerts, and career guidance, helping them identify suitable opportunities and prepare accordingly. In a country like India, where competition for jobs is extremely high and small skills can make a big difference, computer typing acts as a foundation for employability and career growth. Knowledge Hunt bridges the gap between basic education and job readiness by equipping students with essential typing and computer skills that increase efficiency, confidence, and chances of selection. Through its focused and practical approach, Knowledge Hunt empowers Indian youth to become digitally competent and employment-ready, ensuring that they are not left behind in an increasingly technology-driven work environment.",
            "Computer education has become one of the most important pillars of employment and career development in modern India, as technology is now deeply integrated into almost every sector of the economy. From government offices, banks, schools, hospitals, courts, and railways to private companies, startups, and small businesses, computers are used daily for data management, communication, documentation, billing, analysis, and decision-making. As a result, basic computer knowledge is no longer considered an additional skill but a minimum requirement for most jobs. Skills such as typing, word processing, spreadsheets, internet usage, email communication, data entry, and digital record maintenance are essential for roles like office assistant, clerk, data entry operator, receptionist, accountant, customer support executive, and many government and semi-government positions. Despite this growing demand, a large number of students in India complete their formal education without adequate practical computer training, because the traditional education system often focuses more on theoretical subjects and examinations rather than hands-on digital skills. This creates a gap between education and employment, where graduates hold degrees but lack job-ready computer skills, leading to unemployment or underemployment. The situation is more challenging for students from rural and semi-urban areas, where access to computers, quality training centres, and digital awareness is limited, reducing their competitiveness in the job market. Computer education helps bridge this gap by equipping students with practical knowledge that improves efficiency, accuracy, and confidence in the workplace. With proper computer training, students can apply for a wide range of jobs in both the public and private sectors and also explore self-employment opportunities such as freelancing, online services, digital documentation, and small business management. Furthermore, computer education supports career growth by enabling employees to adapt to new technologies, software, and work processes, making them more productive and valuable to organisations. In todayâ€™s competitive environment, employers prefer candidates who can handle digital tools independently and contribute from the first day of work. In a country like India, where the youth population is large and job competition is intense, computer education plays a crucial role in improving employability and reducing skill mismatch. It empowers students not only to secure jobs but also to become confident, independent, and future-ready individuals. As technology continues to evolve, continuous learning in computer education will remain essential for long-term career stability and national development, ensuring that Indian youth are prepared to meet the demands of a digital and knowledge-driven economy.",
        ],
        targetChars: 800,
        type: "paragraph"
    }
};

// ================= GLOBAL VARIABLES =================
let currentLesson = 1;
let text = "";
let startTime = null;
let timer = null;
let correctChars = 0;
let wrongChars = 0;
let totalCharsTyped = 0;
let targetChars = 0;
let wordsTyped = 0;
let wrongWords = 0;
let isTestActive = false;

// DOM Elements
const lessonItems = document.querySelectorAll('.lesson-item');
const lessonTitle = document.getElementById('lesson-title');
const lessonDescription = document.getElementById('lesson-description');
const instructionText = document.getElementById('instruction-text');
const displayText = document.getElementById('display-text');
const typingInput = document.getElementById('typing-input');
const startBtn = document.getElementById('start-btn');
const resetBtn = document.getElementById('reset-btn');
const nextBtn = document.getElementById('next-btn');
const gameArea = document.getElementById('game-area');
const typingArea = document.getElementById('typing-area');
const paragraphSelector = document.getElementById('paragraph-selector');
const paragraphDropdown = document.getElementById('paragraph-dropdown');
const textDisplay = document.getElementById('text-display');
const charsRemaining = document.getElementById('chars-remaining');

// Stats elements
const timeElement = document.getElementById('time');
const wpmElement = document.getElementById('wpm');
const accuracyElement = document.getElementById('accuracy');
const errorsElement = document.getElementById('errors');
const cpmElement = document.getElementById('cpm');
const progressElement = document.getElementById('progress');
const charTargetElement = document.getElementById('char-target');
const progressPercentElement = document.getElementById('progress-percent');
const progressFillElement = document.getElementById('progress-fill');

// Detailed stats elements
const correctCharsElement = document.getElementById('correct-chars');
const wrongCharsElement = document.getElementById('wrong-chars');
const typedCharsElement = document.getElementById('typed-chars');
const remainingCharsElement = document.getElementById('remaining-chars');
const wordsTypedElement = document.getElementById('words-typed');
const wrongWordsElement = document.getElementById('wrong-words');

// ================= FUNCTIONS =================

// Generate alphabet text
function generateAlphabetText(forward) {
    let result = "";
    const alphabet = "abcdefghijklmnopqrstuvwxyz";

    if (forward) {
        for (let i = 0; i < 50; i++) {
            result += alphabet + " ";
        }
    } else {
        for (let i = 0; i < 50; i++) {
            result += alphabet.split('').reverse().join('') + " ";
        }
    }
    return result;
}

// Load lesson
function loadLesson(lessonNumber) {
    currentLesson = lessonNumber;
    const lesson = lessons[lessonNumber];

    // ðŸ”¹ Toggle UI based on lesson type
    toggleUIForLessonType(lesson.type);

    // ðŸ”¹ Update header text (FIXED PLACE)
    if (lesson.type === 'typefall') {
        lessonTitle.textContent = lesson.title;
        lessonDescription.textContent = '';
        instructionText.textContent = '';
    } else {
        lessonTitle.textContent = `Lesson ${lessonNumber}: ${lesson.title}`;
        lessonDescription.textContent = lesson.description;
        instructionText.textContent = lesson.description;
    }

    // ðŸ”¹ Target characters
    targetChars = lesson.targetChars;
    charTargetElement.textContent = targetChars;

    // ðŸ”¹ Reset stats
    resetTest();

    // ðŸ”¹ Handle lesson content
    if (lesson.type === "paragraph") {
        paragraphSelector.style.display = 'block';
        setupParagraphDropdown(lesson.paragraphs);
        text = lesson.paragraphs[0];
        updateDisplayText(text);
    }
    else if (lesson.type === "typefall") {
        paragraphSelector.style.display = 'none';

        if (!gameArea.innerHTML.trim()) {
            loadTypeFallGame();
        }
    }
    else {
        paragraphSelector.style.display = 'none';
        text = lesson.text;
        if (currentLesson !== 9) {
            updateDisplayText(text);
        }
    }

    // ðŸ”¹ Update active lesson in sidebar
    lessonItems.forEach(item => {
        item.classList.toggle(
            'active',
            parseInt(item.dataset.lesson) === lessonNumber
        );
    });

    // ðŸ”¹ Update progress
    updateProgressBar();

    // ðŸ”¹ Focus input (not for game)
    if (lesson.type !== "typefall") {
        typingInput.focus();
    }
}




// Update display text with color coding
function updateDisplayText(textContent) {
    const textToType = document.getElementById('text-to-type');
    textToType.innerHTML = '';

    // Create spans for each character
    for (let i = 0; i < textContent.length; i++) {
        const span = document.createElement('span');
        span.textContent = textContent[i];
        span.id = `char-${i}`;
        span.className = 'char-default';

        if (textContent[i] === '\n') {
            const br = document.createElement('br');
            textToType.appendChild(br);
        } else if (textContent[i] === ' ') {
            span.textContent = ' ';
            textToType.appendChild(span);
        } else {
            textToType.appendChild(span);
        }
    }

    // Update remaining chars display
    charsRemaining.textContent = `${textContent.length} characters remaining`;
}

// Setup paragraph dropdown
function setupParagraphDropdown(paragraphs) {
    paragraphDropdown.innerHTML = '<option value="0">Select a paragraph...</option>';

    paragraphs.forEach((para, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `Paragraph ${index + 1} (${para.length} chars)`;
        paragraphDropdown.appendChild(option);
    });
}

// Change paragraph
function changeParagraph() {
    const lesson = lessons[currentLesson];
    const selectedIndex = parseInt(paragraphDropdown.value);

    if (lesson.paragraphs && lesson.paragraphs[selectedIndex]) {
        text = lesson.paragraphs[selectedIndex];
        updateDisplayText(text);
        resetTest();
    }
}


// Start test
function startTest() {
    if (isTestActive) return;

    typingInput.disabled = false;
    typingInput.focus();
    isTestActive = true;
    textDisplay.classList.add('active');

    startBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
    startBtn.onclick = pauseTest;

    if (!startTime) {
        startTime = new Date();
        timer = setInterval(updateTime, 1000);
    }
}

// Pause test
function pauseTest() {
    if (!isTestActive) return;

    clearInterval(timer);
    timer = null;
    isTestActive = false;
    textDisplay.classList.remove('active');

    typingInput.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
    startBtn.onclick = startTest;
}

// Reset test
function resetTest() {
    // Stop timers
    clearInterval(timer);
    timer = null;
    startTime = null;
    isTestActive = false;
    textDisplay.classList.remove('active');

    // Reset counters
    correctChars = 0;
    wrongChars = 0;
    totalCharsTyped = 0;
    wordsTyped = 0;
    wrongWords = 0;

    // Reset UI
    typingInput.value = '';
    typingInput.disabled = true;

    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Practice';
    startBtn.onclick = startTest;

    // Reset stats
    timeElement.textContent = '0s';
    wpmElement.textContent = '0';
    accuracyElement.textContent = '100%';
    errorsElement.textContent = '0';
    cpmElement.textContent = '0';
    progressElement.textContent = '0%';
    correctCharsElement.textContent = '0';
    wrongCharsElement.textContent = '0';
    typedCharsElement.textContent = '0';
    remainingCharsElement.textContent = targetChars;
    wordsTypedElement.textContent = '0';
    wrongWordsElement.textContent = '0';
    progressPercentElement.textContent = '0%';
    progressFillElement.style.width = '0%';

    // Reset text display
    updateDisplayText(text);

    // Update progress bar
    updateProgressBar();
}

// Update time
function updateTime() {
    if (!startTime) return;

    const seconds = Math.floor((new Date() - startTime) / 1000);
    timeElement.textContent = seconds + 's';

    // Update stats
    const typed = typingInput.value;
    updateStats(typed);
}

// Check typing
function checkTyping() {
    if (!isTestActive) startTest();

    const typed = typingInput.value;
    updateStats(typed);
    highlightText(typed);
}

// Update statistics
function updateStats(typed) {
    if (!startTime) return;

    let errors = 0;
    let correct = 0;
    const totalTyped = typed.length;

    // Count correct and wrong characters
    for (let i = 0; i < totalTyped; i++) {
        if (i < text.length && typed[i] === text[i]) {
            correct++;
        } else {
            errors++;
        }
    }

    // Calculate words
    const words = typed.trim().split(/\s+/).filter(word => word.length > 0);
    wordsTyped = words.length;

    // Calculate WPM and CPM
    const minutes = (new Date() - startTime) / 60000;
    const wpm = minutes > 0 ? Math.round((correct / 5) / minutes) : 0;
    const cpm = minutes > 0 ? Math.round(correct / minutes) : 0;
    const accuracy = totalTyped > 0 ? Math.round((correct / totalTyped) * 100) : 100;
    const progress = targetChars > 0 ? Math.min(100, Math.round((totalTyped / targetChars) * 100)) : 0;

    // Update counters
    correctChars = correct;
    wrongChars = errors;
    totalCharsTyped = totalTyped;

    // Update UI
    wpmElement.textContent = wpm;
    accuracyElement.textContent = accuracy + '%';
    errorsElement.textContent = errors;
    cpmElement.textContent = cpm;
    progressElement.textContent = progress + '%';
    correctCharsElement.textContent = correct;
    wrongCharsElement.textContent = errors;
    typedCharsElement.textContent = totalTyped;
    remainingCharsElement.textContent = Math.max(0, targetChars - totalTyped);
    wordsTypedElement.textContent = wordsTyped;
    progressPercentElement.textContent = progress + '%';

    // Update chars remaining
    charsRemaining.textContent = `${Math.max(0, text.length - totalTyped)} characters remaining`;

    // Update progress bar
    updateProgressBar();

    // Check if lesson complete
    if (targetChars > 0 && totalTyped >= targetChars) {
        clearInterval(timer);
        isTestActive = false;
        typingInput.disabled = true;
        textDisplay.classList.remove('active');

        setTimeout(() => {
            alert(`ðŸŽ‰ Congratulations! Lesson ${currentLesson} Completed!\n\n` +
                `Your Score:\n` +
                `â€¢ Speed: ${wpm} WPM\n` +
                `â€¢ Accuracy: ${accuracy}%\n` +
                `â€¢ Errors: ${errors}\n` +
                `â€¢ Time: ${Math.floor((new Date() - startTime) / 1000)} seconds`);
        }, 500);
    }
}

// Highlight text
function highlightText(typed) {
    const typedLength = typed.length;

    // Highlight characters based on correctness
    for (let i = 0; i < typedLength; i++) {
        const charElement = document.getElementById(`char-${i}`);
        if (charElement) {
            if (i < text.length && typed[i] === text[i]) {
                charElement.className = 'correct-char';
            } else {
                charElement.className = 'wrong-char';
            }
        }
    }

    // Highlight current character (next to type)
    if (typedLength < text.length) {
        const currentCharElement = document.getElementById(`char-${typedLength}`);
        if (currentCharElement) {
            currentCharElement.className = 'current-char';
        }
    }
}

// Update progress bar
function updateProgressBar() {
    const typed = typingInput.value.length;
    const progressPercent = targetChars > 0 ? Math.min(100, (typed / targetChars) * 100) : 0;
    progressFillElement.style.width = progressPercent + '%';
}

// Toggle detailed stats
function toggleDetailedStats() {
    const detailedStats = document.getElementById('detailed-stats');
    const toggleBtn = document.querySelector('.toggle-stats');

    if (detailedStats.style.display === 'none' || detailedStats.style.display === '') {
        detailedStats.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Hide Detailed Statistics';
    } else {
        detailedStats.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Show Detailed Statistics';
    }
}

// ================= TYPE-FALL GAME FUNCTIONS =================

function toggleUIForLessonType(lessonType) {
    const lessonHeader = document.querySelector('.lesson-header');
    const lessonInfo = document.getElementById('lesson-info');
    const fingerHints = document.querySelector('.finger-hints');
    const typingArea = document.getElementById('typing-area');
    const statsContainer = document.getElementById('stats-container');
    const toggleStatsBtn = document.querySelector('.toggle-stats');
    const detailedStats = document.getElementById('detailed-stats');
    const gameArea = document.getElementById('game-area');

    const safeHide = el => { if (el) el.style.display = 'none'; };
    const safeShow = (el, display = '') => { if (el) el.style.display = display; };

    if (lessonType === 'typefall') {
        safeHide(lessonHeader);
        safeHide(lessonInfo);
        safeHide(fingerHints);
        safeHide(typingArea);
        safeHide(statsContainer);
        safeHide(toggleStatsBtn);
        safeHide(detailedStats);

        safeShow(gameArea, 'flex');
    } else {
        safeShow(lessonHeader);
        safeShow(lessonInfo);
        safeShow(fingerHints);
        safeShow(typingArea, 'flex');
        safeShow(statsContainer, 'grid');
        safeHide(detailedStats);
        safeShow(toggleStatsBtn, 'flex');

        safeHide(gameArea);
    }
    if (lessonType !== 'typefall') {
        gameArea.innerHTML = '';
    }
}


// Load TypeFall Game
function loadTypeFallGame() {
    gameArea.innerHTML = `
        <div class="game-header">
            <h1><i class="fas fa-keyboard"></i> TypeFall</h1>
            <div class="game-stats">
                <div class="stat-box">
                    <span class="stat-label">Score</span>
                    <span id="game-score" class="stat-value">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Lives</span>
                    <span id="game-lives" class="stat-value">3</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Combo</span>
                    <span id="game-combo" class="stat-value">0x</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Level</span>
                    <span id="game-level" class="stat-value">1</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Words</span>
                    <span id="game-words-typed" class="stat-value">0</span>
                </div>
            </div>
        </div>

        <div class="game-container">
            <div id="typefall-game-area"></div>
            <div class="input-container">
                <input type="text" id="typefall-word-input" placeholder="Type the falling words here..." autocomplete="off" style="flex:1; min-width:300px; padding:18px 25px; font-size:1.3rem; border:none; border-radius:12px; background:rgba(255,255,255,0.1); color:white; outline:none; border:2px solid rgba(0,173,181,0.5); transition:all 0.3s;">
                <button id="typefall-start-btn" class="btn" style="padding:18px 30px; font-size:1.1rem; font-weight:bold; border:none; border-radius:12px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:10px; background:linear-gradient(to right,#06d6a0,#0cb487); color:white;"><i class="fas fa-play"></i> Start Game</button>
                <button id="typefall-pause-btn" class="btn" style="padding:18px 30px; font-size:1.1rem; font-weight:bold; border:none; border-radius:12px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:10px; background:linear-gradient(to right,#ffd166,#ffb347); color:#1a1a2e;"><i class="fas fa-pause"></i> Pause</button>
            </div>
            
            <div class="instructions" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; border-left:5px solid #00adb5;">
                <h3 style="color:#00fff5; margin-bottom:15px; font-size:1.4rem;"><i class="fas fa-info-circle"></i> How to Play</h3>
                <ul style="list-style-position:inside; padding-left:10px;">
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Type the falling words before they reach the bottom</li>
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Each correct word increases your score</li>
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Missed words cost you a life</li>
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Build combos for bonus points</li>
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Every 20 words increases difficulty</li>
                    <li style="margin-bottom:10px; color:#c0c0e0; line-height:1.5;">Look out for special words: 
                        <span style="font-weight:bold; padding:2px 8px; border-radius:5px; margin:0 5px; background:linear-gradient(to bottom right,#ff9f1a,#ffbf00); border:2px solid #e68a00; color:#1a1a2e;">Bonus</span> (extra points), 
                        <span style="font-weight:bold; padding:2px 8px; border-radius:5px; margin:0 5px; background:linear-gradient(to bottom right,#e74c3c,#ff6b6b); border:2px solid #c0392b; color:white;">Fast</span> (falls quickly), 
                        <span style="font-weight:bold; padding:2px 8px; border-radius:5px; margin:0 5px; background:linear-gradient(to bottom right,#06d6a0,#0cb487); border:2px solid #059669; color:white;">Slow</span> (slows all words)
                    </li>
                </ul>
            </div>
        </div>

        <!-- ================= GAME FOOTER ================= -->
<div class="game-footer"
     style="padding:20px;
            background:rgba(0,0,0,0.3);
            border-top:2px solid rgba(255,255,255,0.1);
            display:flex;
            justify-content:space-between;
            align-items:center;
            flex-wrap:wrap;
            gap:20px;">

    <!-- Powerups -->
    <div class="powerup-indicators"
         style="display:flex; gap:20px; flex-wrap:wrap;">

        <div class="powerup-indicator"
             id="slow-indicator"
             style="padding:12px 20px;
                    border-radius:10px;
                    background:rgba(255,255,255,0.1);
                    border:2px solid rgba(6,214,160,0.3);
                    color:#06d6a0;
                    display:none;">
            <i class="fas fa-clock"></i>
            Slow Time: <span id="slow-timer">0s</span>
        </div>

        <div class="powerup-indicator"
             id="combo-indicator"
             style="padding:12px 20px;
                    border-radius:10px;
                    background:rgba(255,255,255,0.1);
                    border:2px solid rgba(255,209,102,0.3);
                    color:#ffd166;">
            <i class="fas fa-bolt"></i>
            Combo Multiplier: <span id="combo-multiplier">1x</span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls"
         style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">

        <button id="typefall-reset-btn"
                class="btn btn-reset"
                style="padding:18px 30px;
                       font-size:1.1rem;
                       font-weight:bold;
                       border:none;
                       border-radius:12px;
                       cursor:pointer;
                       display:flex;
                       align-items:center;
                       gap:10px;
                       background:linear-gradient(to right,#ef476f,#e63946);
                       color:white;">
            <i class="fas fa-redo"></i> Reset
        </button>

        <div class="difficulty">
            <span style="color:white; margin-right:8px;">Difficulty:</span>
            <select id="difficulty-select"
                    style="padding:12px 20px;
                           border-radius:10px;
                           background:rgba(255,255,255,0.1);
                           color:white;
                           border:2px solid rgba(0,173,181,0.5);
                           font-size:1rem;
                           outline:none;
                           cursor:pointer;">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
            </select>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
        <div id="game-over-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
            <div class="modal-content" style="background:linear-gradient(135deg,#0f3460,#533483); padding:40px; border-radius:20px; text-align:center; max-width:500px; width:90%; border:3px solid #00adb5; box-shadow:0 20px 50px rgba(0,0,0,0.7);">
                <h2 style="color:#00fff5; font-size:2.5rem; margin-bottom:25px;"><i class="fas fa-gamepad"></i> Game Over</h2>
                <div class="final-stats" style="background:rgba(0,0,0,0.3); padding:25px; border-radius:15px; margin-bottom:30px;">
                    <p style="font-size:1.4rem; margin:15px 0; color:white;">Final Score: <span id="final-score">0</span></p>
                    <p style="font-size:1.4rem; margin:15px 0; color:white;">Words Typed: <span id="final-words">0</span></p>
                    <p style="font-size:1.4rem; margin:15px 0; color:white;">Highest Combo: <span id="final-combo">0x</span></p>
                    <p style="font-size:1.4rem; margin:15px 0; color:white;">Level Reached: <span id="final-level">1</span></p>
                </div>
                <button id="restart-btn" class="btn btn-restart" style="background:linear-gradient(to right,#06d6a0,#0cb487); color:white; font-size:1.3rem; padding:20px 40px; margin:0 auto; border:none; border-radius:12px; cursor:pointer; transition:all 0.3s;"><i class="fas fa-redo"></i> Play Again</button>
            </div>
        </div>
    `;   // âœ… backtick closed correctly


    /* ================= TYPEFALL REPORT BAR ================= */
    const reportHTML = `
        <div class="typefall-report">
            <div><strong>Score:</strong> <span id="rep-score">0</span></div>
            <div><strong>Words:</strong> <span id="rep-words">0</span></div>
            <div><strong>Level:</strong> <span id="rep-level">1</span></div>
        </div>
    `;

    // à¤…à¤—à¤° à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ report à¤¹à¥ˆ à¤¤à¥‹ à¤¹à¤Ÿà¤¾à¤“
    document.querySelector('.typefall-report')?.remove();

    // game-area à¤•à¥‡ à¤ à¥€à¤• à¤¨à¥€à¤šà¥‡ report à¤¡à¤¾à¤²à¥‹
    gameArea.insertAdjacentHTML('afterend', reportHTML);

    // Initialize TypeFall game
    initTypeFallGame();
}

// Initialize TypeFall Game
function initTypeFallGame() {
    // Game variables
    let gameScore = 0;
    let gameLives = 3;
    let gameCombo = 0;
    let gameLevel = 1;
    let gameWordsTyped = 0;
    let gameActive = false;
    let gamePaused = false;
    let animationId;
    let words = [];
    let fallingSpeed = 2;
    let wordInterval;
    let slowModeActive = false;
    let slowModeTimer = 0;
    let comboMultiplier = 1;
    let maxWordsAtOnce = 1;
    let wordSpawnDelay = 2000; // ms

    // Word lists by difficulty
    const easyWords = [
        "cat", "dog", "sun", "rain", "book", "tree", "house", "car", "ball", "fish",
        "bird", "star", "moon", "cloud", "water", "fire", "wind", "snow", "flower", "grass",
        "chair", "table", "door", "window", "light", "dark", "happy", "sad", "big", "small"
    ];

    const mediumWords = [
        "computer", "keyboard", "monitor", "program", "network", "system", "digital", "virtual",
        "language", "algorithm", "database", "website", "browser", "server", "display", "graphics",
        "memory", "storage", "process", "control", "develop", "project", "company", "business",
        "student", "teacher", "library", "college", "university", "graduation"
    ];

    const hardWords = [
        "phenomenon", "comprehensive", "algorithmic", "sophisticated", "architecture",
        "implementation", "configuration", "infrastructure", "authentication", "encryption",
        "cryptography", "virtualization", "optimization", "parallelism", "asynchronous",
        "multithreading", "metaphorical", "philosophical", "psychological", "anthropological",
        "theoretical", "experimental", "methodology", "quantitative", "qualitative"
    ];

    // Special words with their effects
    const specialWords = {
        bonus: {
            words: ["BONUS", "EXTRA", "REWARD", "JACKPOT"],
            type: "bonus-word",
            points: 100
        },
        fast: {
            words: ["FAST", "QUICK", "SPEED", "RUSH"],
            type: "fast-word",
            speedMultiplier: 3
        },
        slow: {
            words: ["SLOW", "FREEZE", "PAUSE", "STOP"],
            type: "slow-word",
            duration: 10 // seconds
        }
    };

    // DOM elements
    const gameArea = document.getElementById('typefall-game-area');
    const wordInput = document.getElementById('typefall-word-input');
    const scoreElement = document.getElementById('game-score');
    const livesElement = document.getElementById('game-lives');
    const comboElement = document.getElementById('game-combo');
    const levelElement = document.getElementById('game-level');
    const wordsTypedElement = document.getElementById('game-words-typed');
    const startBtn = document.getElementById('typefall-start-btn');
    const pauseBtn = document.getElementById('typefall-pause-btn');
    const resetBtn = document.getElementById('typefall-reset-btn');
    const restartBtn = document.getElementById('restart-btn');
    const gameOverModal = document.getElementById('game-over-modal');
    const finalScoreElement = document.getElementById('final-score');
    const finalWordsElement = document.getElementById('final-words');
    const finalComboElement = document.getElementById('final-combo');
    const finalLevelElement = document.getElementById('final-level');
    const slowTimerElement = document.getElementById('slow-timer');
    const comboMultiplierElement = document.getElementById('combo-multiplier');
    const difficultySelect = document.getElementById('difficulty-select');

    // Initialize game
    function initGame() {
        gameScore = 0;
        gameLives = 3;
        gameCombo = 0;
        gameLevel = 1;
        gameWordsTyped = 0;
        fallingSpeed = 2;
        maxWordsAtOnce = 1;
        wordSpawnDelay = 2000;
        slowModeActive = false;
        slowModeTimer = 0;
        comboMultiplier = 1;
        words = [];

        updateUI();
        gameArea.innerHTML = '';
        wordInput.value = '';
        wordInput.disabled = false;
        wordInput.focus();

        // Clear any existing intervals
        clearInterval(wordInterval);
        cancelAnimationFrame(animationId);

        // Hide game over modal
        gameOverModal.style.display = 'none';
    }

    // Update UI elements
    function updateUI() {
        scoreElement.textContent = gameScore;
        livesElement.textContent = gameLives;
        comboElement.textContent = gameCombo + 'x';
        levelElement.textContent = gameLevel;
        wordsTypedElement.textContent = gameWordsTyped;
        comboMultiplierElement.textContent = comboMultiplier + 'x';

        // Update slow mode timer
        if (slowModeActive) {
            slowTimerElement.textContent = slowModeTimer.toFixed(1) + 's';
            document.getElementById('slow-indicator').style.display = 'block';
        } else {
            document.getElementById('slow-indicator').style.display = 'none';
        }
         // ðŸ”¹ Bottom Report Update
    const repScore = document.getElementById('rep-score');
    const repWords = document.getElementById('rep-words');
    const repLevel = document.getElementById('rep-level');

    if (repScore) repScore.textContent = gameScore;
    if (repWords) repWords.textContent = gameWordsTyped;
    if (repLevel) repLevel.textContent = gameLevel;

    }
       


    // Generate a random word
    function generateWord() {
        if (!gameActive || gamePaused || words.length >= maxWordsAtOnce) return;

        // Determine which word list to use based on level
        let wordList;
        if (gameLevel <= 3) {
            wordList = easyWords;
        } else if (gameLevel <= 6) {
            wordList = [...easyWords, ...mediumWords];
        } else {
            wordList = [...easyWords, ...mediumWords, ...hardWords];
        }

        // Random chance for special word (10%)
        let isSpecial = Math.random() < 0.1;
        let wordText, wordType, wordClass = 'normal-word';
        let speedMultiplier = 1;
        let points = 10;

        if (isSpecial) {
            const specialTypes = Object.keys(specialWords);
            const randomType = specialTypes[Math.floor(Math.random() * specialTypes.length)];
            const special = specialWords[randomType];

            wordText = special.words[Math.floor(Math.random() * special.words.length)];
            wordClass = special.type;
            wordType = randomType;

            if (randomType === 'bonus') {
                points = special.points;
            } else if (randomType === 'fast') {
                speedMultiplier = special.speedMultiplier;
            } else if (randomType === 'slow') {
                // Slow word doesn't have speed multiplier, it triggers slow mode
            }
        } else {
            wordText = wordList[Math.floor(Math.random() * wordList.length)];
            wordType = 'normal';
            points = Math.floor(wordText.length * (gameLevel * 0.5));
        }

        // Create word element
        const wordElement = document.createElement('div');
        wordElement.className = `falling-word ${wordClass}`;
        wordElement.textContent = wordText;
        wordElement.dataset.word = wordText.toLowerCase();
        wordElement.dataset.type = wordType;
        wordElement.dataset.points = points;
        wordElement.dataset.speedMultiplier = speedMultiplier;

        // Style the word
        wordElement.style.position = 'absolute';
        wordElement.style.fontSize = '1.5rem';
        wordElement.style.fontWeight = 'bold';
        wordElement.style.padding = '12px 20px';
        wordElement.style.borderRadius = '10px';
        wordElement.style.textShadow = '1px 1px 3px rgba(0,0,0,0.7)';
        wordElement.style.transition = 'all 0.1s linear';
        wordElement.style.whiteSpace = 'nowrap';
        wordElement.style.userSelect = 'none';
        wordElement.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';

        // Set class-specific styles
        if (wordClass === 'normal-word') {
            wordElement.style.background = 'linear-gradient(to bottom right, #4a69bd, #6a89cc)';
            wordElement.style.border = '2px solid #3c5aa8';
            wordElement.style.color = 'white';
        } else if (wordClass === 'bonus-word') {
            wordElement.style.background = 'linear-gradient(to bottom right, #ff9f1a, #ffbf00)';
            wordElement.style.border = '2px solid #e68a00';
            wordElement.style.color = '#1a1a2e';
            wordElement.style.animation = 'pulse 1.5s infinite';
        } else if (wordClass === 'fast-word') {
            wordElement.style.background = 'linear-gradient(to bottom right, #e74c3c, #ff6b6b)';
            wordElement.style.border = '2px solid #c0392b';
            wordElement.style.color = 'white';
            wordElement.style.animation = 'shake 0.5s infinite';
        } else if (wordClass === 'slow-word') {
            wordElement.style.background = 'linear-gradient(to bottom right, #06d6a0, #0cb487)';
            wordElement.style.border = '2px solid #059669';
            wordElement.style.color = 'white';
            wordElement.style.animation = 'glow 2s infinite';
        }

        // Random horizontal position
        const maxLeft = gameArea.offsetWidth - 180;
        const left = Math.floor(Math.random() * maxLeft);
        wordElement.style.left = `${left}px`;
        wordElement.style.top = '-50px';

        gameArea.appendChild(wordElement);

        // Add to words array
        words.push({
            element: wordElement,
            text: wordText.toLowerCase(),
            type: wordType,
            points: points,
            speedMultiplier: speedMultiplier,
            top: -50
        });
    }

    // Move words down
    function moveWords() {
        if (!gameActive || gamePaused) return;

        // Update slow mode timer
        if (slowModeActive) {
            slowModeTimer -= 0.016; // Roughly 60fps
            if (slowModeTimer <= 0) {
                slowModeActive = false;
                slowModeTimer = 0;
            }
        }

        const currentSpeed = slowModeActive ? fallingSpeed * 0.3 : fallingSpeed;

        for (let i = words.length - 1; i >= 0; i--) {
            const word = words[i];
            const speed = currentSpeed * word.speedMultiplier;

            word.top += speed;
            word.element.style.top = `${word.top}px`;

            // Check if word reached bottom
            if (word.top > gameArea.offsetHeight - 50) {
                // Word missed
                removeWord(i);
                loseLife();
                resetCombo();
            }
        }

        updateUI();
        animationId = requestAnimationFrame(moveWords);
    }

    // Check word input
    function checkWordInput() {
        const input = wordInput.value.trim().toLowerCase();

        for (let i = 0; i < words.length; i++) {
            if (words[i].text === input) {
                // Correct word typed
                const word = words[i];

                // Apply special effects
                if (word.type === 'bonus') {
                    addScore(word.points * comboMultiplier);
                    showFloatingText(`+${word.points * comboMultiplier}!`, word.element, '#ffd700');
                } else if (word.type === 'slow') {
                    activateSlowMode(specialWords.slow.duration);
                    addScore(word.points * comboMultiplier);
                    showFloatingText('SLOW TIME!', word.element, '#06d6a0');
                } else if (word.type === 'fast') {
                    addScore(word.points * comboMultiplier);
                    showFloatingText('FAST!', word.element, '#ff6b6b');
                } else {
                    addScore(word.points * comboMultiplier);
                    showFloatingText(`+${word.points * comboMultiplier}`, word.element, '#00fff5');
                }

                // Increase combo
                increaseCombo();

                // Remove word
                removeWord(i);

                // Clear input
                wordInput.value = '';

                // Increase words typed and check for level up
                gameWordsTyped++;
                if (gameWordsTyped % 20 === 0) {
                    levelUp();
                }

                return;
            }
        }
    }

    // Add score
    function addScore(points) {
        gameScore += Math.floor(points);
        updateUI();
    }

    // Increase combo
    function increaseCombo() {
        gameCombo++;

        // Increase combo multiplier every 5 combos
        if (gameCombo % 5 === 0) {
            comboMultiplier = Math.min(5, comboMultiplier + 0.5);
        }

        updateUI();
    }

    // Reset combo
    function resetCombo() {
        gameCombo = 0;
        comboMultiplier = 1;
        updateUI();
    }

    // Lose life
    function loseLife() {
        gameLives--;
        updateUI();

        // Show visual feedback
        gameArea.style.borderColor = '#ff6b6b';
        setTimeout(() => {
            gameArea.style.borderColor = '';
        }, 100);

        // Check game over
        if (gameLives <= 0) {
            gameOver();
        }
    }

    // Level up
    function levelUp() {
        gameLevel++;

        // Increase difficulty
        fallingSpeed += 0.5;
        maxWordsAtOnce = Math.min(3, Math.floor(gameLevel / 3) + 1);
        wordSpawnDelay = Math.max(500, wordSpawnDelay - 100);

        // Update word spawn interval
        clearInterval(wordInterval);
        wordInterval = setInterval(generateWord, wordSpawnDelay);

        // Show level up message
        showLevelUpMessage();
        updateUI();
    }

    // Activate slow mode
    function activateSlowMode(duration) {
        slowModeActive = true;
        slowModeTimer = duration;

        // Visual effect
        gameArea.style.borderColor = '#06d6a0';
        setTimeout(() => {
            if (!slowModeActive) {
                gameArea.style.borderColor = '';
            }
        }, 100);
    }

    // Remove word from game
    function removeWord(index) {
        const word = words[index];
        word.element.remove();
        words.splice(index, 1);
    }

    // Show floating text
    function showFloatingText(text, element, color) {
        const floatingText = document.createElement('div');
        floatingText.textContent = text;
        floatingText.style.position = 'absolute';
        floatingText.style.left = element.style.left;
        floatingText.style.top = element.style.top;
        floatingText.style.color = color;
        floatingText.style.fontSize = '1.8rem';
        floatingText.style.fontWeight = 'bold';
        floatingText.style.textShadow = '0 0 5px rgba(0,0,0,0.8)';
        floatingText.style.zIndex = '1000';
        floatingText.style.transition = 'all 0.5s ease-out';

        gameArea.appendChild(floatingText);

        // Animate floating up
        setTimeout(() => {
            floatingText.style.top = `${parseInt(element.style.top) - 50}px`;
            floatingText.style.opacity = '0';
        }, 10);

        // Remove after animation
        setTimeout(() => {
            floatingText.remove();
        }, 600);
    }

    // Show level up message
    function showLevelUpMessage() {
        const message = document.createElement('div');
        message.textContent = `LEVEL ${gameLevel}!`;
        message.style.position = 'absolute';
        message.style.top = '50%';
        message.style.left = '50%';
        message.style.transform = 'translate(-50%, -50%)';
        message.style.fontSize = '4rem';
        message.style.fontWeight = 'bold';
        message.style.color = '#ffd700';
        message.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
        message.style.zIndex = '1000';
        message.style.opacity = '1';
        message.style.transition = 'opacity 1s';

        gameArea.appendChild(message);

        // Fade out
        setTimeout(() => {
            message.style.opacity = '0';
        }, 1000);

        // Remove
        setTimeout(() => {
            message.remove();
        }, 2000);
    }

    // Game over
    function gameOver() {
        gameActive = false;
        gamePaused = false;

        // Clear intervals
        clearInterval(wordInterval);
        cancelAnimationFrame(animationId);

        // Update final stats
        finalScoreElement.textContent = gameScore;
        finalWordsElement.textContent = gameWordsTyped;
        finalComboElement.textContent = gameCombo + 'x';
        finalLevelElement.textContent = gameLevel;

        // Show game over modal
        setTimeout(() => {
            gameOverModal.style.display = 'flex';
        }, 1000);
    }

    // Start game
    function startGame() {
        if (gameActive) return;

        initGame();
        gameActive = true;
        gamePaused = false;

        // Set difficulty
        const difficulty = difficultySelect.value;
        if (difficulty === 'easy') {
            fallingSpeed = 1.5;
            wordSpawnDelay = 2500;
        } else if (difficulty === 'hard') {
            fallingSpeed = 3;
            wordSpawnDelay = 1500;
        }

        // Start word generation
        wordInterval = setInterval(generateWord, wordSpawnDelay);

        // Start animation
        moveWords();

        // Update button
        startBtn.innerHTML = '<i class="fas fa-play"></i> Restart';
        wordInput.focus();
    }

    // Pause/resume game
    function togglePause() {
        if (!gameActive) return;

        gamePaused = !gamePaused;

        if (gamePaused) {
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            wordInput.disabled = true;
        } else {
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            wordInput.disabled = false;
            wordInput.focus();
            moveWords();
        }
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);

    pauseBtn.addEventListener('click', togglePause);

    resetBtn.addEventListener('click', () => {
        if (gameActive) {
            if (confirm('Are you sure you want to reset? Current progress will be lost.')) {
                initGame();
                gameActive = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Game';
            }
        } else {
            initGame();
        }
    });

    wordInput.addEventListener('input', checkWordInput);

    wordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            checkWordInput();
        }
    });

    restartBtn.addEventListener('click', () => {
        gameOverModal.style.display = 'none';
        startGame();
    });

    // Initialize on load
    initGame();

    // Focus input when clicking on game area
    gameArea.addEventListener('click', () => {
        wordInput.focus();
    });
}

// ================= INITIALIZATION =================
function init() {
    loadLesson(currentLesson);
    setupEventListeners();
}

// Setup event listeners
function setupEventListeners() {
    // Lesson selection
    lessonItems.forEach(item => {
        item.addEventListener('click', () => {
            const lessonNumber = parseInt(item.dataset.lesson);
            loadLesson(lessonNumber);
        });
    });

    // Start typing button
    startBtn.addEventListener('click', startTest);

    // Reset button
    resetBtn.addEventListener('click', resetTest);

    // Next lesson button
    nextBtn.addEventListener('click', () => {
        if (currentLesson < 10) {
            loadLesson(currentLesson + 1);
        } else {
            alert("ðŸŽŠ Congratulations! You have completed all lessons!");
        }
    });

    // Typing input events
    typingInput.addEventListener('input', checkTyping);
    typingInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && currentLesson === 7) {
            e.preventDefault();
            typingInput.value += '\n';
            checkTyping();
        }
    });

    // Paragraph selection
    paragraphDropdown.addEventListener('change', changeParagraph);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', init);