<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Student Education Portal Blog</title>
  <meta name="description" content="Student Education Portal Blog">

  <!-- Open Graph -->
  <meta property="og:title" id="ogTitle">
  <meta property="og:description" id="ogDescription">
  <meta property="og:image" id="ogImage">
  <meta property="og:type" content="article">
  <meta property="og:url" id="ogUrl">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" id="twitterTitle">
  <meta name="twitter:description" id="twitterDescription">
  <meta name="twitter:image" id="twitterImage">

  <!-- External CSS -->
  <link rel="stylesheet" href="blog.css">

</head>

<body>

  <div class="blog-container">

    <h1 id="blogTitle"></h1>
    <div class="meta" id="blogMeta"></div>
    <div class="like-section">
      <button onclick="likeBlog()">üëç Like</button>
      <span id="likeCount"></span>

      <button onclick="shareWhatsApp()">üì≤ WhatsApp</button>
      <button onclick="shareFacebook()">üìò Facebook</button>
      <button onclick="copyLink()">üîó Copy Link</button>
    </div>
    <!-- Blog Main Image -->
    <div id="blogImageContainer"></div>

    <!-- Blog Content -->
    <div class="content" id="blogContent"></div>
    <h3>Comments</h3>

    <div id="commentsContainer"></div>

    <div class="comment-form">
      <input type="text" id="commentName" placeholder="Your Name">
      <textarea id="commentMessage" placeholder="Write your comment..."></textarea>
      <button onclick="submitComment()">Post Comment</button>
    </div>
    <hr>

    <h3>Related Articles</h3>
    <div id="relatedBlogs"></div>

  </div>

  <script>

    const API_BASE = "https://student-education-portal-backend.onrender.com";
    let currentBlogId = null;

    function getSlug() {
      const params = new URLSearchParams(window.location.search);
      return params.get('slug');
    }

    async function loadBlog() {

      const slug = getSlug();
      if (!slug) {
        document.body.innerHTML = "Blog not found";
        return;
      }

      try {

        const res = await fetch(API_BASE + '/api/blogs/' + slug);
        const data = await res.json();

        if (!data.success) {
          document.body.innerHTML = "Blog not found";
          return;
        }

        const blog = data.blog;

        // SAVE ID FOR LIKE & COMMENT
        currentBlogId = blog._id;

        // ===== SEO =====
        const plainText = blog.content.replace(/<[^>]*>/g, '');
        const description = blog.metaDescription || plainText.substring(0, 150);
        const title = blog.metaTitle || blog.title + " | Student Education Portal";

        document.title = title;
        document.querySelector('meta[name="description"]').setAttribute("content", description);

        document.getElementById('ogTitle').setAttribute("content", title);
        document.getElementById('ogDescription').setAttribute("content", description);
        document.getElementById('ogUrl').setAttribute("content", window.location.href);

        document.getElementById('twitterTitle').setAttribute("content", title);
        document.getElementById('twitterDescription').setAttribute("content", description);

        if (blog.image) {
          document.getElementById('ogImage').setAttribute("content", blog.image);
          document.getElementById('twitterImage').setAttribute("content", blog.image);

          document.getElementById('blogImageContainer').innerHTML =
            `<img src="${blog.image}" class="main-blog-image">`;
        }

        document.getElementById('blogTitle').innerText = blog.title;

        document.getElementById('blogMeta').innerHTML =
          "Category: " + (blog.category || 'General') +
          " | " +
          new Date(blog.createdAt).toLocaleDateString('en-IN') +
          " | üëÅ " + (blog.views || 0) + " Views";

        // LIKE COUNT SHOW
        const likeEl = document.getElementById('likeCount');
        if (likeEl) {
          likeEl.innerText = (blog.likes || 0) + " Likes";
        }
        // YOUTUBE EMBED
        let processedContent = blog.content
          .replace(
            /https:\/\/www\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g,
            `<iframe src="https://www.youtube.com/embed/$1"
            frameborder="0" allowfullscreen class="youtube-embed"></iframe>`
          )
          .replace(
            /https:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/g,
            `<iframe src="https://www.youtube.com/embed/$1"
            frameborder="0" allowfullscreen class="youtube-embed"></iframe>`
          );

        document.getElementById('blogContent').innerHTML = processedContent;

        renderComments(blog.comments);
        loadRelatedBlogs(blog.slug);

      } catch (err) {
        document.body.innerHTML = "Failed to load blog";
      }
    }


    // ================= LIKE =================

    async function likeBlog() {

      if (!currentBlogId) return;

      try {

        const res = await fetch(API_BASE + '/api/blogs/like/' + currentBlogId, {
          method: 'POST'
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('likeCount').innerText =
            data.likes + " Likes";
        }

      } catch (err) {
        console.error("Like error", err);
      }
    }


    // ================= COMMENTS =================

    function renderComments(comments) {

      const container = document.getElementById('commentsContainer');

      if (!comments || comments.length === 0) {
        container.innerHTML = "<p>No comments yet.</p>";
        return;
      }

      let html = "";

      comments.forEach(c => {
        html += `
      <div class="single-comment">
        <strong>${c.name}</strong>
        <small>${new Date(c.createdAt).toLocaleDateString('en-IN')}</small>
        <p>${c.message}</p>
      </div>
    `;
      });

      container.innerHTML = html;
    }


    // ================= RELATED =================

    async function loadRelatedBlogs(slug) {

      const res = await fetch(API_BASE + '/api/blogs/related/' + slug);
      const data = await res.json();
      const container = document.getElementById('relatedBlogs');

      if (!data.success || data.blogs.length === 0) {
        container.innerHTML = "<p>No related articles found.</p>";
        return;
      }

      let html = "<div class='related-grid'>";

      data.blogs.forEach(blog => {

        const preview =
          blog.content.replace(/<[^>]*>/g, '').substring(0, 100) + "...";

        html += `
      <div class="related-card" onclick="openRelated('${blog.slug}')">
        ${blog.image ? `<img src="${blog.image}" class="related-image">` : ""}
        <h4>${blog.title}</h4>
        <p>${preview}</p>
      </div>
    `;
      });

      html += "</div>";
      container.innerHTML = html;
    }

    function openRelated(slug) {
      window.location.href = "blog.html?slug=" + slug;
    }

    loadBlog();
    async function submitComment() {

      const name = document.getElementById('commentName').value.trim();
      const message = document.getElementById('commentMessage').value.trim();

      if (!name || !message) {
        alert("Name and message required");
        return;
      }

      try {

        const res = await fetch(API_BASE + '/api/blogs/comment/' + currentBlogId, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, message })
        });

        const data = await res.json();

        if (data.success) {
          renderComments(data.comments);
          document.getElementById('commentName').value = '';
          document.getElementById('commentMessage').value = '';
        }

      } catch (err) {
        alert("Failed to post comment");
      }
    }

    function shareWhatsApp() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://wa.me/?text=${url}`, '_blank');
}

function shareFacebook() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function copyLink() {
  navigator.clipboard.writeText(window.location.href);
  alert("Link copied!");
}

  </script>

</body>

</html>