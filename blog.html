<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title id="metaTitle">Student Education Portal Blog</title>
  <meta name="description" id="metaDescription" content="Student Education Portal Blog">

  <!-- Open Graph -->
  <meta property="og:title" id="ogTitle" content="Student Education Portal Blog">
  <meta property="og:description" id="ogDescription" content="Student Education Portal Blog">
  <meta property="og:image" id="ogImage" content="">
  <meta property="og:type" content="article">
  <meta property="og:url" id="ogUrl" content="">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" id="twitterTitle" content="">
  <meta name="twitter:description" id="twitterDescription" content="">
  <meta name="twitter:image" id="twitterImage" content="">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 40px;
      background: #f8fafc;
    }

    .blog-container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin-bottom: 10px;
    }

    .meta {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .content {
      line-height: 1.7;
    }
  </style>
</head>

<body>

  <div class="blog-container">
    <h1 id="blogTitle"></h1>
    <div class="meta" id="blogMeta"></div>
    <div class="content" id="blogContent"></div>
    <hr style="margin:40px 0;" />

    <h3>Related Articles</h3>
    <div id="relatedBlogs" style="margin-top:20px;"></div>
  </div>
  <button onclick="likeBlog()">üëç Like</button>
  <span id="likeCount"></span>
  <script>

    const API_BASE = "https://student-education-portal-backend.onrender.com";

    function getSlug() {
      const params = new URLSearchParams(window.location.search);
      return params.get('slug');
    }

    async function loadBlog() {

      const slug = getSlug();

      if (!slug) {
        document.body.innerHTML = "Blog not found";
        return;
      }

      const res = await fetch(API_BASE + '/api/blogs/' + slug);
      const data = await res.json();

      if (!data.success) {
        document.body.innerHTML = "Blog not found";
        return;
      }

      const blog = data.blog;
      loadRelatedBlogs(blog.slug);
      // ===== SEO + OPEN GRAPH UPDATE =====

      const plainText = blog.content.replace(/<[^>]*>/g, '');
      const description = blog.metaDescription || plainText.substring(0, 150);
      const title = blog.metaTitle || blog.title + " | Student Education Portal";

      // Standard Meta
      document.title = title;

      document.querySelector('meta[name="description"]')
        .setAttribute("content", description);

      // Open Graph
      document.getElementById('ogTitle')
        .setAttribute("content", title);

      document.getElementById('ogDescription')
        .setAttribute("content", description);

      document.getElementById('ogUrl')
        .setAttribute("content", window.location.href);

      if (blog.image) {
        document.getElementById('ogImage')
          .setAttribute("content", blog.image);

        document.getElementById('twitterImage')
          .setAttribute("content", blog.image);
      }

      // Twitter
      document.getElementById('twitterTitle')
        .setAttribute("content", title);

      document.getElementById('twitterDescription')
        .setAttribute("content", description);


      document.getElementById('blogTitle').innerText = blog.title;
      document.getElementById('blogMeta').innerHTML =
        "Category: " + (blog.category || 'General') +
        " | " +
        new Date(blog.createdAt).toLocaleDateString('en-IN') +
        " | üëÅ " + (blog.views || 0) + " Views";

      if (blog.image) {
        document.getElementById('blogTitle').insertAdjacentHTML(
          "afterend",
          `<img src="${blog.image}"
              style="width:100%; border-radius:12px; margin:20px 0;" />`
        );
      }
      let processedContent = blog.content;

      // Convert YouTube links to embed
      processedContent = processedContent.replace(
        /https:\/\/www\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g,
        `<iframe width="100%" height="400"
    src="https://www.youtube.com/embed/$1"
    frameborder="0" allowfullscreen></iframe>`
      );

      document.getElementById('blogContent').innerHTML = processedContent;

    }
    async function loadRelatedBlogs(slug) {

      const res = await fetch(API_BASE + '/api/blogs/related/' + slug);
      const data = await res.json();

      const container = document.getElementById('relatedBlogs');

      if (!data.success || data.blogs.length === 0) {
        container.innerHTML = "<p>No related articles found.</p>";
        return;
      }

      let html = "<div style='display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;'>";

      data.blogs.forEach(blog => {

        const preview = blog.content
          .replace(/<[^>]*>/g, '')
          .substring(0, 100) + "...";

        html += `
        <div style="
            background:#f8fafc;
            padding:15px;
            border-radius:10px;
            cursor:pointer;
        " onclick="openRelated('${blog.slug}')">

            ${blog.image ? `
                <img src="${blog.image}" 
                     style="width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:10px;">
            ` : ""}

            <strong>${blog.title}</strong>
            <p style="font-size:13px;color:#555;">${preview}</p>
        </div>
      `;
      });

      html += "</div>";

      container.innerHTML = html;
    }
    function openRelated(slug) {
      window.location.href = "blog.html?slug=" + slug;
    }

    loadBlog();

  </script>

</body>

</html>